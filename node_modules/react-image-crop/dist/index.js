import t,{PureComponent as e,createRef as r}from"react";function i(t,e,r){return Math.min(Math.max(t,e),r)}function o(t){return t&&t.width&&t.height}function s(t,e,r){const i=h({width:0,height:0,...t},e,r),o=i.aspect||1;return i.width&&(i.height=i.width/o),i.height&&(i.width=i.height*o),i.y+i.height>r&&(i.height=r-i.y,i.width=i.height*o),i.x+i.width>e&&(i.width=e-i.x,i.height=i.width/o),"px"===t.unit?i:n(i,e,r)}function n(t,e,r){return"%"===t.unit?t:{unit:"%",aspect:t.aspect,x:t.x/e*100,y:t.y/r*100,width:t.width/e*100,height:t.height/r*100}}function h(t,e,r){return t.unit?"px"===t.unit?t:{unit:"px",aspect:t.aspect,x:t.x*e/100,y:t.y*r/100,width:t.width*e/100,height:t.height*r/100}:{...t,unit:"px"}}function a(t,e,r,i){const o=h(e,r,i),s=h(t,r,i),n={...o};if(!o.aspect)return o.x<0?(n.x=0,n.width+=o.x):o.x+o.width>r&&(n.width=r-o.x),o.y+o.height>i&&(n.height=i-o.y),n;let a=!1;o.x<0?(n.x=0,n.width+=o.x,n.height=n.width/o.aspect,a=!0):o.x+o.width>r&&(n.width=r-o.x,n.height=n.width/o.aspect,a=!0),a&&s.y>n.y&&(n.y=o.y+(o.height-n.height));let d=!1;return n.y+n.height>i&&(n.height=i-o.y,n.width=n.height*o.aspect,d=!0),d&&s.x>n.x&&(n.x=o.x+(o.width-n.width)),n}function d(t,e,r,i,o){let s,n;return"nw"===e||"se"===e?(s=o/i,n=r.top-r.left*s):(s=-o/i,n=r.top+(o-r.left*s)),s*t+n}function c(t){var e,r,i="";if("string"==typeof t||"number"==typeof t)i+=t;else if("object"==typeof t)if(Array.isArray(t))for(e=0;e<t.length;e++)t[e]&&(r=c(t[e]))&&(i&&(i+=" "),i+=r);else for(e in t)t[e]&&(i&&(i+=" "),i+=e);return i}const p={aspect:0,x:0,y:0,width:0,height:0,unit:"px"};class l extends e{constructor(){super(...arguments),this.componentRef=r(),this.cropSelectRef=r(),this.mouseDownOnCrop=!1,this.dragStarted=!1,this.keysDown=new Set,this.evData={clientStartX:0,clientStartY:0,cropStartWidth:0,cropStartHeight:0,cropStartX:0,cropStartY:0,xDiff:0,yDiff:0,xInversed:!1,yInversed:!1,xCrossOver:!1,yCrossOver:!1,startXCrossOver:!1,startYCrossOver:!1,isResize:!1,ord:"nw",cropOffset:{top:0,left:0}},this.state={dimensions:{width:0,height:0}},this.onCropPointerDown=t=>{var e,r;const{crop:i=p,disabled:o}=this.props,{width:s,height:n}=this.state.dimensions,a=h(i,s,n),d=this.componentRef.current;if(o||!d)return;t.preventDefault(),this.bindDocMove(),d.focus({preventScroll:!0});const c=null===(e=t.target)||void 0===e?void 0:e.dataset.ord,l="nw"===c||"w"===c||"sw"===c,g="nw"===c||"n"===c||"ne"===c,f=a.aspect?{top:d.offsetTop,left:d.offsetLeft}:{top:0,left:0};this.evData={clientStartX:t.pageX,clientStartY:t.pageY,cropStartWidth:a.width,cropStartHeight:a.height,cropStartX:l?a.x+a.width:a.x,cropStartY:g?a.y+a.height:a.y,xDiff:0,yDiff:0,xInversed:l,yInversed:g,xCrossOver:l,yCrossOver:g,startXCrossOver:l,startYCrossOver:g,isResize:Boolean(null===(r=t.target)||void 0===r?void 0:r.dataset.ord),ord:c,cropOffset:f},this.mouseDownOnCrop=!0,this.setState({cropIsActive:!0})},this.onComponentPointerDown=t=>{const e=this.componentRef.current,r=null==e?void 0:e.firstChild;if(!e||t.target!==r)return;const{crop:i,disabled:s,locked:a,keepSelection:d,onChange:c}=this.props;if(s||a||d&&o(i))return;t.preventDefault(),this.bindDocMove(),e.focus({preventScroll:!0});const p={unit:"px",aspect:i?i.aspect:void 0,x:t.nativeEvent.offsetX,y:t.nativeEvent.offsetY,width:0,height:0};this.evData={clientStartX:t.pageX,clientStartY:t.pageY,cropStartWidth:p.width,cropStartHeight:p.height,cropStartX:p.x,cropStartY:p.y,xDiff:0,yDiff:0,xInversed:!1,yInversed:!1,xCrossOver:!1,yCrossOver:!1,startXCrossOver:!1,startYCrossOver:!1,isResize:!0,ord:"nw",cropOffset:{top:0,left:0}},this.mouseDownOnCrop=!0;const{width:l,height:g}=this.state.dimensions;c&&c(h(p,l,g),n(p,l,g)),this.setState({cropIsActive:!0,newCropIsBeingDrawn:!0})},this.onDocPointerMove=t=>{const{crop:e,disabled:r,onChange:i,onDragStart:o}=this.props;if(r)return;if(!this.mouseDownOnCrop)return;t.preventDefault(),this.dragStarted||(this.dragStarted=!0,o&&o(t));const{evData:s}=this,a={x:t.pageX,y:t.pageY};let c;if(s.isResize&&(null==e?void 0:e.aspect)&&s.cropOffset&&(a.y=d(a.x,s.ord,s.cropOffset,s.cropStartWidth,s.cropStartHeight)),s.xDiff=a.x-s.clientStartX,s.yDiff=a.y-s.clientStartY,c=s.isResize?this.resizeCrop():this.dragCrop(),c!==e){const{width:t,height:e}=this.state.dimensions;i(h(c,t,e),n(c,t,e))}},this.onComponentKeyDown=t=>{const{crop:e,disabled:r,onChange:s,onComplete:a}=this.props;if(r)return;this.keysDown.add(t.key);let d=!1;if(!o(e))return;const c=this.makeNewCrop(),p=(navigator.platform.match("Mac")?t.metaKey:t.ctrlKey)?l.nudgeStepLarge:t.shiftKey?l.nudgeStepMedium:l.nudgeStep;if(this.keysDown.has("ArrowLeft")&&(c.x-=p,d=!0),this.keysDown.has("ArrowRight")&&(c.x+=p,d=!0),this.keysDown.has("ArrowUp")&&(c.y-=p,d=!0),this.keysDown.has("ArrowDown")&&(c.y+=p,d=!0),d){t.preventDefault();const{width:e,height:r}=this.state.dimensions;c.x=i(c.x,0,e-c.width),c.y=i(c.y,0,r-c.height);const o=h(c,e,r),d=n(c,e,r);s(o,d),a&&a(o,d)}},this.onComponentKeyUp=t=>{this.keysDown.delete(t.key)},this.onDocPointerDone=t=>{const{crop:e=p,disabled:r,onComplete:i,onDragEnd:o}=this.props;if(this.unbindDocMove(),!r&&this.mouseDownOnCrop){this.mouseDownOnCrop=!1,this.dragStarted=!1;const{width:r,height:s}=this.state.dimensions;o&&o(t),i&&i(h(e,r,s),n(e,r,s)),this.setState({cropIsActive:!1,newCropIsBeingDrawn:!1})}}}componentDidMount(){if(this.componentRef.current){const t=this.componentRef.current;this.setState({dimensions:{width:t.clientWidth,height:t.clientHeight}}),this.resizeObserver=new ResizeObserver((([t])=>{this.setState({dimensions:{width:t.contentRect.width,height:t.contentRect.height}}),console.log("Size changed",t.contentRect.width,t.contentRect.height)})),this.resizeObserver.observe(t)}}componentWillUnmount(){var t;null===(t=this.resizeObserver)||void 0===t||t.disconnect()}bindDocMove(){"undefined"!=typeof document&&(document.addEventListener("pointermove",this.onDocPointerMove),document.addEventListener("pointerup",this.onDocPointerDone),document.addEventListener("pointercancel",this.onDocPointerDone))}unbindDocMove(){"undefined"!=typeof document&&(document.removeEventListener("pointermove",this.onDocPointerMove),document.removeEventListener("pointerup",this.onDocPointerDone),document.removeEventListener("pointercancel",this.onDocPointerDone))}getCropStyle(){const t=this.makeNewCrop(this.props.crop?this.props.crop.unit:"px");return{top:`${t.y}${t.unit}`,left:`${t.x}${t.unit}`,width:`${t.width}${t.unit}`,height:`${t.height}${t.unit}`}}getNewSize(){const{crop:t,minWidth:e=0,maxWidth:r,minHeight:o=0,maxHeight:s}=this.props,{evData:n}=this,{width:h,height:a}=this.state.dimensions;if(!t)return{width:0,height:0};let d,c=n.cropStartWidth+n.xDiff;return n.xCrossOver&&(c=Math.abs(c)),c=i(c,e,r||h),d=t.aspect?c/t.aspect:n.cropStartHeight+n.yDiff,n.yCrossOver&&(d=Math.min(Math.abs(d),n.cropStartY)),d=i(d,o,s||a),t.aspect&&(c=i(d*t.aspect,0,h)),{width:c,height:d}}dragCrop(){const t=this.makeNewCrop(),{evData:e}=this,{width:r,height:o}=this.state.dimensions;return t.x=i(e.cropStartX+e.xDiff,0,r-t.width),t.y=i(e.cropStartY+e.yDiff,0,o-t.height),t}resizeCrop(){const{evData:t}=this,{crop:e=p}=this.props,r=this.makeNewCrop(),{ord:i}=t;t.xInversed&&(t.xDiff-=2*t.cropStartWidth),t.yInversed&&(t.yDiff-=2*t.cropStartHeight);const o=this.getNewSize();let s=t.cropStartX,n=t.cropStartY;t.xCrossOver&&(s=r.x+(r.width-o.width)),t.yCrossOver&&(n=!1===t.lastYCrossover?r.y-o.height:r.y+(r.height-o.height));const{width:h,height:d}=this.state.dimensions,c=a(e,{unit:r.unit,x:s,y:n,width:o.width,height:o.height,aspect:r.aspect},h,d);return r.aspect||l.xyOrds.indexOf(i)>-1?(r.x=c.x,r.y=c.y,r.width=c.width,r.height=c.height):l.xOrds.indexOf(i)>-1?(r.x=c.x,r.width=c.width):l.yOrds.indexOf(i)>-1&&(r.y=c.y,r.height=c.height),t.lastYCrossover=t.yCrossOver,this.crossOverCheck(this.evData),r}createCropSelection(){const{disabled:e,locked:r,ruleOfThirds:i,crop:o}=this.props,s=this.getCropStyle();return t.createElement("div",{ref:this.cropSelectRef,style:s,className:"ReactCrop__crop-selection",onPointerDown:this.onCropPointerDown},!e&&!r&&t.createElement("div",{className:"ReactCrop__drag-elements"},t.createElement("div",{className:"ReactCrop__drag-bar ord-n","data-ord":"n"}),t.createElement("div",{className:"ReactCrop__drag-bar ord-e","data-ord":"e"}),t.createElement("div",{className:"ReactCrop__drag-bar ord-s","data-ord":"s"}),t.createElement("div",{className:"ReactCrop__drag-bar ord-w","data-ord":"w"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-nw","data-ord":"nw"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-n","data-ord":"n"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-ne","data-ord":"ne"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-e","data-ord":"e"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-se","data-ord":"se"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-s","data-ord":"s"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-sw","data-ord":"sw"}),t.createElement("div",{className:"ReactCrop__drag-handle ord-w","data-ord":"w"})),i&&t.createElement(t.Fragment,null,t.createElement("div",{className:"ReactCrop__rule-of-thirds-hz"}),t.createElement("div",{className:"ReactCrop__rule-of-thirds-vt"})))}makeNewCrop(t="px"){var e,r,i,o,s;const a=this.props.crop||p,d={unit:a.unit||t,aspect:null!==(e=a.aspect)&&void 0!==e?e:p.aspect,x:null!==(r=a.x)&&void 0!==r?r:p.x,y:null!==(i=a.y)&&void 0!==i?i:p.y,width:null!==(o=a.width)&&void 0!==o?o:p.width,height:null!==(s=a.height)&&void 0!==s?s:p.height},{width:c,height:l}=this.state.dimensions;return"px"===t?h(d,c,l):n(d,c,l)}crossOverCheck(t){const{minWidth:e,minHeight:r}=this.props;!e&&(!t.xCrossOver&&-Math.abs(t.cropStartWidth)-t.xDiff>=0||t.xCrossOver&&-Math.abs(t.cropStartWidth)-t.xDiff<=0)&&(t.xCrossOver=!t.xCrossOver),!r&&(!t.yCrossOver&&-Math.abs(t.cropStartHeight)-t.yDiff>=0||t.yCrossOver&&-Math.abs(t.cropStartHeight)-t.yDiff<=0)&&(t.yCrossOver=!t.yCrossOver)}render(){const{children:e,circularCrop:r,className:i,style:s,crop:n,disabled:h,locked:a,ruleOfThirds:d}=this.props,{width:p,height:l}=this.state.dimensions,{cropIsActive:g,newCropIsBeingDrawn:f}=this.state,w=p&&l&&o(n)?this.createCropSelection():null,v=function(...t){for(var e,r,i=0,o="";i<t.length;)(e=t[i++])&&(r=c(e))&&(o&&(o+=" "),o+=r);return o}("ReactCrop",i,{"ReactCrop--active":g,"ReactCrop--disabled":h,"ReactCrop--locked":a,"ReactCrop--new-crop":f,"ReactCrop--fixed-aspect":n&&n.aspect,"ReactCrop--circular-crop":n&&r,"ReactCrop--rule-of-thirds":n&&d,"ReactCrop--invisible-crop":!this.dragStarted&&n&&!n.width&&!n.height});return t.createElement("div",{ref:this.componentRef,className:v,style:s,tabIndex:0,onPointerDown:this.onComponentPointerDown,onKeyDown:this.onComponentKeyDown,onKeyUp:this.onComponentKeyUp},e,w)}}l.xOrds=["e","w"],l.yOrds=["n","s"],l.xyOrds=["nw","ne","se","sw"],l.nudgeStep=1,l.nudgeStepMedium=10,l.nudgeStepLarge=100;export{l as Crop,p as EMPTY_CROP,i as clamp,a as containCrop,n as convertToPercentCrop,h as convertToPixelCrop,o as isCropDrawn,s as makeAspectCrop,d as straightenYPath};
